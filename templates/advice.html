{% extends "base.html" %}

{% block title %}Advice - BrainBudget{% endblock %}

{% block content %}
<!-- Advice Page -->
<div class="min-h-screen" style="background-color: #EFDFC5;">
    <!-- Navigation Header -->
    <header class="absolute top-4 left-4 right-4 z-10 animate-fadeIn">
        <div class="flex justify-between items-center">
            <div class="flex space-x-8">
                <a href="/home" class="flex items-center space-x-2 hover:opacity-80 transition-colors" style="color: #252B2B;">
                    <span>ğŸ </span>
                    <span>Home</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Navigation links removed - only on homepage -->
            </div>
        </div>
    </header>

    <!-- Header Section -->
    <div class="relative py-16 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <div class="mb-6">
                <span class="text-6xl">ğŸ’¬</span>
            </div>
            <div class="inline-block px-8 py-4 rounded-full brain-gradient mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-white">
                    Advice
                </h1>
            </div>
            <p class="text-lg max-w-2xl mx-auto leading-relaxed" style="color: #252B2B;">
                Personalized advice for budgeting, debt, and savings that works for you. Practical guidance without the overwhelming jargon.
            </p>
        </div>
    </div>

    <!-- Advice Content -->
    <div class="py-12 px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Advice Filter Bar -->
            <div class="flex flex-wrap items-center justify-between mb-8 p-6 rounded-3xl" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                <div class="flex items-center space-x-4">
                    <h2 class="text-xl font-bold" style="color: #380F17;">Your Personalized Advice</h2>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background-color: #7CEC86; color: #380F17;">5 New Tips</span>
                </div>
                <div class="flex space-x-3">
                    <select id="advice-category" class="px-4 py-2 rounded-xl border focus:outline-none focus:ring-2" style="border-color: #380F17; focus:ring-color: #380F17;">
                        <option value="all">All Topics</option>
                        <option value="budgeting">ğŸ“Š Smart Budgeting</option>
                        <option value="debt">ğŸ’³ Debt Management</option>
                        <option value="savings">ğŸ¦ Smart Saving</option>
                        <option value="goals">ğŸ¯ Goal Achievement</option>
                        <option value="impulse">ğŸ›’ Impulse Control</option>
                    </select>
                    <button onclick="refreshAdvice()" class="px-6 py-2 rounded-xl font-semibold transition-colors hover:shadow-md" style="background-color: #380F17; color: #EFDFC5;">
                        ğŸ”„ New Advice
                    </button>
                </div>
            </div>

            <!-- Featured Advice Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Today's Featured Advice -->
                <div class="backdrop-blur-sm rounded-3xl p-6 card-hover" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: #EFDFC5;">
                            <span style="color: #380F17; font-size: 1.5rem;">â­</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">Today's Featured Tip</h3>
                            <p class="text-sm opacity-80">Personalized for you</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h4 class="text-lg font-semibold">ğŸ§  The "Interest-Based" Budget</h4>
                        <p class="leading-relaxed">Instead of forcing boring categories, organize your budget around what you find interesting. Make "Fun Money" a legitimate category - it reduces guilt and prevents larger impulse purchases.</p>
                        <div class="flex space-x-2 mt-4">
                            <button onclick="likeAdvice('featured')" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #EFDFC5; color: #380F17;">
                                ğŸ‘ Helpful
                            </button>
                            <button onclick="saveAdvice('featured')" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #8F0B13; color: #EFDFC5;">
                                ğŸ“Œ Save
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ADHD-Specific Tip -->
                <div class="backdrop-blur-sm rounded-3xl p-6 card-hover" style="background-color: rgba(143, 11, 19, 0.9); color: #EFDFC5;">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: #EFDFC5;">
                            <span style="color: #8F0B13; font-size: 1.5rem;">ğŸ§ </span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">Smart Money Hack</h3>
                            <p class="text-sm opacity-80">Executive function friendly</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h4 class="text-lg font-semibold">âš¡ The "2-Minute Money Rule"</h4>
                        <p class="leading-relaxed">If a financial task takes less than 2 minutes (like checking your account balance), do it immediately. This prevents the procrastination spiral and keeps you connected to your money.</p>
                        <div class="flex space-x-2 mt-4">
                            <button onclick="likeAdvice('adhd-tip')" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #EFDFC5; color: #8F0B13;">
                                ğŸ‘ Love It
                            </button>
                            <button onclick="tryAdvice('adhd-tip')" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                                âœ¨ Try Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Advice Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column - Advice Categories -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Budgeting Advice -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">ğŸ“Š</span>
                            Smart Budgeting
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Advice Card 1 -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8); border-left: 4px solid #7CEC86;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">ğŸ’š</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold mb-2" style="color: #380F17;">Start with 3 Categories Only</h3>
                                        <p class="text-sm mb-3" style="color: #252B2B;">Many people get overwhelmed with too many choices. Begin with: Essentials, Fun Money, and Future Self. You can add more categories later when this feels automatic.</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs px-3 py-1 rounded-full" style="background-color: #7CEC86; color: #380F17;">âœ… Beginner Friendly</span>
                                            <div class="flex space-x-2">
                                                <button onclick="likeAdvice('budget-1')" class="text-lg">ğŸ‘</button>
                                                <button onclick="saveAdvice('budget-1')" class="text-lg">ğŸ“Œ</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advice Card 2 -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8); border-left: 4px solid #FFC107;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">ğŸ’¡</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold mb-2" style="color: #380F17;">Visual Budget Tracking</h3>
                                        <p class="text-sm mb-3" style="color: #252B2B;">Use colorful progress bars or even physical jars for cash. Visual learners respond better to visual cues than spreadsheet numbers. Make it pretty and engaging!</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs px-3 py-1 rounded-full" style="background-color: #FFC107; color: #380F17;">ğŸ¨ Visual Learner</span>
                                            <div class="flex space-x-2">
                                                <button onclick="likeAdvice('budget-2')" class="text-lg">ğŸ‘</button>
                                                <button onclick="shareAdvice('budget-2')" class="text-lg">ğŸ“¤</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advice Card 3 -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8); border-left: 4px solid #8B5CF6;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">ğŸ¯</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold mb-2" style="color: #380F17;">The "Good Enough" Budget</h3>
                                        <p class="text-sm mb-3" style="color: #252B2B;">Perfectionism kills motivation. Aim for 80% accuracy, not 100%. A "good enough" budget you actually use beats a perfect one you abandon after two weeks.</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs px-3 py-1 rounded-full" style="background-color: #8B5CF6; color: white;">ğŸ’ª Mindset Shift</span>
                                            <div class="flex space-x-2">
                                                <button onclick="likeAdvice('budget-3')" class="text-lg">ğŸ‘</button>
                                                <button onclick="implementAdvice('budget-3')" class="text-lg">âš¡</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Impulse Control Advice -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">ğŸ›’</span>
                            Impulse Purchase Management
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Impulse Advice 1 -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8); border-left: 4px solid #FF6B6B;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">â°</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold mb-2" style="color: #380F17;">The Smart "Wait" Strategy</h3>
                                        <p class="text-sm mb-3" style="color: #252B2B;">For purchases over $50: Wait 1 day per $10. A $100 item = 10 day wait. Impulse desires fade, but genuine needs persist. This filters out impulse from actual necessity.</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs px-3 py-1 rounded-full" style="background-color: #FF6B6B; color: white;">ğŸ§˜ Impulse Control</span>
                                            <div class="flex space-x-2">
                                                <button onclick="likeAdvice('impulse-1')" class="text-lg">ğŸ‘</button>
                                                <button onclick="setReminder('impulse-1')" class="text-lg">â°</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Impulse Advice 2 -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8); border-left: 4px solid #4ECDC4;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">ğŸ“</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold mb-2" style="color: #380F17;">The "Want vs Need" Text Test</h3>
                                        <p class="text-sm mb-3" style="color: #252B2B;">Before buying, text a friend: "I want to buy [item] because [reason]." Explaining purchases out loud engages your prefrontal cortex and often reveals the impulse nature.</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs px-3 py-1 rounded-full" style="background-color: #4ECDC4; color: white;">ğŸ¤ Accountability</span>
                                            <div class="flex space-x-2">
                                                <button onclick="likeAdvice('impulse-2')" class="text-lg">ğŸ‘</button>
                                                <button onclick="findBuddy('impulse-2')" class="text-lg">ğŸ‘¥</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="space-y-6">
                    <!-- Saved Advice -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">ğŸ“Œ</span>
                            Saved Tips
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="p-3 rounded-lg cursor-pointer hover:shadow-md transition-colors" style="background-color: rgba(239, 223, 197, 0.6);">
                                <h4 class="font-semibold" style="color: #380F17;">2-Minute Money Rule</h4>
                                <p class="text-xs" style="color: #4C4F54;">Saved yesterday</p>
                            </div>
                            <div class="p-3 rounded-lg cursor-pointer hover:shadow-md transition-colors" style="background-color: rgba(239, 223, 197, 0.6);">
                                <h4 class="font-semibold" style="color: #380F17;">Visual Budget Tracking</h4>
                                <p class="text-xs" style="color: #4C4F54;">Saved 3 days ago</p>
                            </div>
                            <div class="p-3 rounded-lg cursor-pointer hover:shadow-md transition-colors" style="background-color: rgba(239, 223, 197, 0.6);">
                                <h4 class="font-semibold" style="color: #380F17;">Interest-Based Budget</h4>
                                <p class="text-xs" style="color: #4C4F54;">Saved 1 week ago</p>
                            </div>
                        </div>
                        <button onclick="viewAllSaved()" class="w-full mt-4 p-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                            View All Saved
                        </button>
                    </div>

                    <!-- Advice Categories -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">ğŸ¯</span>
                            Browse Topics
                        </h3>
                        <div class="space-y-2">
                            <button onclick="filterAdvice('budgeting')" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #380F17; color: #EFDFC5;">
                                ğŸ“Š Smart Budgeting
                            </button>
                            <button onclick="filterAdvice('debt')" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #8F0B13; color: #EFDFC5;">
                                ğŸ’³ Debt Strategy
                            </button>
                            <button onclick="filterAdvice('savings')" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #252B2B; color: #EFDFC5;">
                                ğŸ¦ Smart Saving
                            </button>
                            <button onclick="filterAdvice('goals')" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #4C4F54; color: #EFDFC5;">
                                ğŸ¯ Goal Achievement
                            </button>
                        </div>
                    </div>

                    <!-- Daily Motivation -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="mr-3 text-2xl">ğŸ’ª</span>
                            Daily Motivation
                        </h3>
                        <div class="text-sm leading-relaxed">
                            <p class="mb-3">ğŸŒŸ <strong>Progress Over Perfection:</strong> Every small financial win counts!</p>
                            <p class="text-xs opacity-80">Your brain has unique strengths. These tips are designed to work WITH your brain, not against it. Celebrate every victory!</p>
                            <button onclick="shareMotivation()" class="mt-3 px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #EFDFC5; color: #380F17;">
                                Share Success
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-8 text-center animate-fadeIn">
        <div class="max-w-4xl mx-auto px-4">
            <p class="text-sm" style="color: #4C4F54;">
                BrainBudget - Making budgeting fun | powered by <span class="font-semibold" style="color: #8F0B13;">Niostudio</span>
            </p>
        </div>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/core.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Wait for Firebase to initialize
    setTimeout(() => {
        // Check authentication state
        firebase.auth.onAuthStateChanged(user => {
            if (user) {
                console.log('User authenticated, loading personalized advice...');
                loadAdvice();
                // Show authenticated features
                document.querySelectorAll('.auth-required').forEach(el => {
                    el.style.display = 'block';
                });
            } else {
                console.log('User not authenticated - showing demo content');
                showSuccessToast('ğŸ‘‹ Welcome! Please log in to get personalized financial advice tailored to your needs.');
                // Hide authenticated features
                document.querySelectorAll('.auth-required').forEach(el => {
                    el.style.display = 'none';
                });
                // Show demo content instead of redirecting
                loadDemoAdvice();
            }
        });
    }, 1000);
    
    // Set up advice filtering
    setupAdviceFiltering();
    
    // Auto-refresh advice periodically (only if user is logged in)
    setInterval(() => {
        if (firebase.auth.currentUser) {
            loadAdvice();
        }
    }, 1800000); // Every 30 minutes
    
    function loadAdvice() {
        // Get Firebase token for authentication
        const user = firebase.auth().currentUser;
        if (!user) {
            console.log('User not logged in - showing demo advice');
            return;
        }
        
        user.getIdToken().then(token => {
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            // Load personalized advice based on user profile
            fetch('/api/advice/personalized?limit=5', { headers })
                .then(response => {
                    console.log('Advice API response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Advice API response data:', data);
                    if (data.success) {
                        updateAdviceDisplay(data.advice);
                        showSuccessToast('ğŸ¯ Personalized advice loaded based on your spending patterns!');
                    } else {
                        console.log('API returned error:', data.message);
                        showSuccessToast('ğŸ’¡ Loading general advice while we learn your preferences!');
                    }
                })
                .catch(error => {
                    console.log('Advice API error:', error);
                    showSuccessToast('ğŸ’¡ Loading demo advice - upload some transactions for personalized tips!');
                });
            
            // Load quick tips
            fetch('/api/advice/quick-tips?limit=3', { headers })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateQuickTips(data.quick_tips);
                    }
                })
                .catch(error => {
                    console.log('Could not load quick tips:', error);
                });
        }).catch(error => {
            console.log('Authentication error:', error);
        });
    }
    
    function loadDemoAdvice() {
        // Show demo content for non-authenticated users
        console.log('Loading demo advice content');
        const demoAdvice = [
            {
                title: "Start with 3 Simple Categories",
                summary: "Instead of overwhelming yourself with 20+ budget categories, begin with just 3: Essentials (rent, groceries), Fun Money (entertainment, hobbies), and Future Self (savings, debt). You can always add more later!",
                category: "budgeting",
                adhd_friendly: true
            }
        ];
        
        updateAdviceDisplay(demoAdvice);
        showSuccessToast('ğŸ’¡ This is demo advice! Log in to get personalized tips based on your spending.');
    }
    
    function updateAdviceDisplay(advice) {
        console.log('Personalized advice loaded:', advice);
        // Update the featured advice with real data
        if (advice && advice.length > 0) {
            const featured = advice[0];
            updateFeaturedAdvice(featured);
        }
    }
    
    function updateFeaturedAdvice(advice) {
        // Update the "Today's Featured Tip" section with real advice
        const featuredSection = document.querySelector('[onclick*="featured"]').closest('div').closest('div');
        if (featuredSection && advice) {
            const titleElement = featuredSection.querySelector('h4');
            const contentElement = featuredSection.querySelector('p');
            
            if (titleElement && advice.title) {
                titleElement.textContent = `ğŸ§  ${advice.title}`;
            }
            if (contentElement && advice.summary) {
                contentElement.textContent = advice.summary;
            }
        }
    }
    
    function updateQuickTips(tips) {
        console.log('Quick tips loaded:', tips);
        // Could update a quick tips section if we add one
    }
    
    function updateSavedAdvice(saved) {
        console.log('Saved advice loaded:', saved);
    }
    
    function setupAdviceFiltering() {
        const categorySelect = document.getElementById('advice-category');
        categorySelect.addEventListener('change', function() {
            filterAdvice(this.value);
        });
    }
    
    // Advice interaction functions
    window.refreshAdvice = function() {
        showSuccessToast('ğŸ”„ Loading fresh, personalized advice for you!');
        loadAdvice();
    };
    
    window.likeAdvice = function(adviceId) {
        const user = firebase.auth().currentUser;
        if (!user) {
            showSuccessToast('Please log in to save your feedback! ğŸ”');
            return;
        }
        
        user.getIdToken().then(token => {
            fetch('/api/advice/interaction', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    advice_id: adviceId, 
                    action: 'helpful',
                    feedback: { helpful: true, rating: 5 }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessToast(data.message || 'ğŸ‘ Thanks for the feedback! This helps us provide better advice.');
                } else {
                    showSuccessToast('ğŸ‘ Feedback noted! We\'ll improve our suggestions.');
                }
            })
            .catch(error => {
                console.log('Feedback error:', error);
                showSuccessToast('ğŸ‘ Thanks for the feedback! This helps us provide better advice.');
            });
        });
    };
    
    window.saveAdvice = function(adviceId) {
        const user = firebase.auth().currentUser;
        if (!user) {
            showSuccessToast('Please log in to save advice! ğŸ”');
            return;
        }
        
        // For now, use interaction API to track saves
        user.getIdToken().then(token => {
            fetch('/api/advice/interaction', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    advice_id: adviceId, 
                    action: 'started',  // User wants to implement this advice
                    feedback: { saved: true }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessToast('ğŸ“Œ Advice saved! You can find it in your profile.');
                } else {
                    showSuccessToast('ğŸ“Œ Advice saved locally!');
                }
            })
            .catch(error => {
                console.log('Save error:', error);
                showSuccessToast('ğŸ“Œ Advice saved! You can find it in your saved tips section.');
            });
        });
    };
    
    window.shareAdvice = function(adviceId) {
        // Copy advice link to clipboard
        const url = `${window.location.origin}/advice#${adviceId}`;
        navigator.clipboard.writeText(url).then(() => {
            showSuccessToast('ğŸ“¤ Advice link copied to clipboard! Share it with friends who need financial tips.');
        }).catch(() => {
            showSuccessToast('ğŸ“¤ Share this great advice with your friends! Link: ' + url);
        });
        
        // Track sharing interaction
        trackAdviceInteraction(adviceId, 'shared');
    };
    
    window.tryAdvice = function(adviceId) {
        // Mark as started and provide implementation guidance
        const user = firebase.auth().currentUser;
        if (!user) {
            showSuccessToast('Please log in to track your progress! ğŸ”');
            return;
        }
        
        user.getIdToken().then(token => {
            fetch('/api/advice/progress-check', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    advice_id: adviceId, 
                    progress_status: 'in_progress',
                    notes: 'User wants to try implementing this advice'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessToast('âœ¨ Great! We\'re tracking your progress. You\'ve got this! ğŸ’ª');
                } else {
                    showSuccessToast('âœ¨ Ready to try it out? Take it one small step at a time!');
                }
            })
            .catch(() => {
                showSuccessToast('âœ¨ You\'re ready to implement this! Start with just one small action today.');
            });
        });
    };
    
    window.implementAdvice = function(adviceId) {
        // Show implementation steps
        showSuccessToast('âš¡ Break it into tiny steps: 1) Read the tip again 2) Pick ONE action 3) Set a 5-minute timer 4) Just start!');
        
        // Track implementation attempt
        trackAdviceInteraction(adviceId, 'started');
    };
    
    window.setReminder = function(adviceId) {
        // Create a simple reminder using browser notification
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    setTimeout(() => {
                        new Notification('ğŸ’¡ BrainBudget Reminder', {
                            body: 'Time to work on your financial goal! Remember that advice tip?',
                            icon: '/static/icons/icon-192x192.png'
                        });
                    }, 1800000); // 30 minutes
                    showSuccessToast('â° Reminder set! We\'ll ping you in 30 minutes to check on your progress.');
                } else {
                    showSuccessToast('â° Set a phone reminder for 30 minutes to work on this financial tip!');
                }
            });
        } else {
            showSuccessToast('â° Set a phone reminder for 30 minutes to work on this financial tip!');
        }
        
        trackAdviceInteraction(adviceId, 'viewed');
    };
    
    window.findBuddy = function(adviceId) {
        // Encourage social accountability
        showSuccessToast('ğŸ‘¥ Tell a friend about this goal! Social accountability increases success by 65%. Text someone right now!');
        
        // Track buddy request
        trackAdviceInteraction(adviceId, 'viewed');
    };
    
    window.filterAdvice = function(category) {
        const user = firebase.auth().currentUser;
        if (!user) {
            showSuccessToast('Please log in to access personalized category advice! ğŸ”');
            return;
        }
        
        showSuccessToast(`ğŸ¯ Loading ${category.replace('_', ' ')} advice just for you!`);
        
        user.getIdToken().then(token => {
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            const url = category === 'all' ? 
                '/api/advice/personalized?limit=8' : 
                `/api/advice/by-category/${category}?limit=6`;
                
            fetch(url, { headers })
                .then(response => {
                    console.log(`Category ${category} API status:`, response.status);
                    return response.json();
                })
                .then(data => {
                    console.log(`Category ${category} API response:`, data);
                    if (data.success) {
                        updateAdviceDisplay(data.advice || data.category);
                        showSuccessToast(`âœ¨ Found ${data.advice ? data.advice.length : 0} personalized tips for ${category.replace('_', ' ')}!`);
                    } else {
                        console.log('Category API error:', data.message);
                        showSuccessToast(`ğŸ’¡ Loading general ${category.replace('_', ' ')} advice while we learn your preferences!`);
                    }
                })
                .catch(error => {
                    console.log('Category filter error:', error);
                    showSuccessToast(`ğŸ’¡ Having trouble loading ${category.replace('_', ' ')} advice. Try the refresh button!`);
                });
        });
    };
    
    window.viewAllSaved = function() {
        const user = firebase.auth().currentUser;
        if (!user) {
            showSuccessToast('Please log in to view your saved advice! ğŸ”');
            return;
        }
        
        // For now, scroll to saved section and highlight it
        const savedSections = document.querySelectorAll('h3');
        let savedSection = null;
        savedSections.forEach(h3 => {
            if (h3.textContent.includes('Saved Tips')) {
                savedSection = h3;
            }
        });
        
        if (savedSection) {
            savedSection.parentElement.scrollIntoView({ behavior: 'smooth' });
            savedSection.parentElement.style.background = 'rgba(124, 236, 134, 0.2)';
            setTimeout(() => {
                savedSection.parentElement.style.background = '';
            }, 2000);
        }
        showSuccessToast('ğŸ“š Here are your saved tips! We\'re working on a full library view.');
    };
    
    window.shareMotivation = function() {
        // Copy motivational message to clipboard
        const message = "ğŸŒŸ Making progress with my financial goals using @BrainBudget! Every small step counts! ğŸ’ª #FinancialWellness #ADHD";
        navigator.clipboard.writeText(message).then(() => {
            showSuccessToast('ğŸŒŸ Motivational message copied! Share your success to inspire others.');
        }).catch(() => {
            showSuccessToast('ğŸŒŸ Share your success: "Making progress with my financial goals! Every small step counts!"');
        });
    };
    
    // Helper function to track advice interactions
    function trackAdviceInteraction(adviceId, action) {
        const user = firebase.auth().currentUser;
        if (!user) return;
        
        user.getIdToken().then(token => {
            fetch('/api/advice/interaction', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    advice_id: adviceId, 
                    action: action
                })
            }).catch(error => {
                console.log('Interaction tracking failed:', error);
            });
        });
    }
    
    // User-friendly animations for advice cards
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe advice cards for entrance animations
    document.querySelectorAll('.card-hover').forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
    
    // Add hover effects for dopamine rewards
    document.querySelectorAll('[onclick*="likeAdvice"]').forEach(button => {
        button.addEventListener('mouseenter', () => {
            button.style.transform = 'scale(1.1)';
        });
        button.addEventListener('mouseleave', () => {
            button.style.transform = 'scale(1)';
        });
    });
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Insights - BrainBudget{% endblock %}

{% block head_scripts %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- Insights Page -->
<div class="min-h-screen" style="background-color: #EFDFC5;">
    <!-- Navigation Header -->
    <header class="absolute top-4 left-4 right-4 z-10 animate-fadeIn">
        <div class="flex justify-between items-center">
            <div class="flex space-x-8">
                <a href="/home" class="flex items-center space-x-2 hover:opacity-80 transition-colors" style="color: #252B2B;">
                    <span>🏠</span>
                    <span>Home</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Navigation links removed - only on homepage -->
            </div>
        </div>
    </header>

    <!-- Header Section -->
    <div class="relative py-16 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <div class="mb-6">
                <span class="text-6xl">💡</span>
            </div>
            <div class="inline-block px-8 py-4 rounded-full brain-gradient mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-white">
                    Insights
                </h1>
            </div>
            <p class="text-lg max-w-2xl mx-auto leading-relaxed" style="color: #252B2B;">
                Intelligent spending pattern analysis with personalized guidance that works with your unique financial habits.
            </p>
        </div>
    </div>

    <!-- Insights Content -->
    <div class="py-12 px-4">
        <div class="max-w-6xl mx-auto">
            
            {% if has_analysis and analysis_results %}
            <!-- Dynamic Analysis Results -->
            <div class="mb-8 p-6 rounded-3xl" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <span class="mr-3 text-3xl">📊</span>
                    Your Analysis Results
                </h2>
                <p class="opacity-80">Processed: {{ analysis_timestamp[:19] if analysis_timestamp else 'Recently' }}</p>
                
                {% if analysis_results.analysis.insights %}
                <div class="mt-6 space-y-4">
                    {% for insight in analysis_results.analysis.insights %}
                    <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.2); border-left: 4px solid #EFDFC5;">
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">{{ insight.icon }}</span>
                            <div>
                                <h3 class="font-semibold text-white">{{ insight.title }}</h3>
                                <p class="text-sm mt-1 opacity-80">{{ insight.message }}</p>
                                {% if insight.recommendation %}
                                <div class="mt-2 text-xs" style="color: #EFDFC5;">💡 {{ insight.recommendation }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Spending Summary -->
                {% if analysis_results.analysis.summary %}
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.2);">
                        <div class="text-2xl font-bold">{{ analysis_results.analysis.summary.total_expenses|currency }}</div>
                        <div class="text-sm opacity-80">Total Expenses</div>
                    </div>
                    <div class="text-center p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.2);">
                        <div class="text-2xl font-bold">{{ analysis_results.analysis.summary.total_income|currency }}</div>
                        <div class="text-sm opacity-80">Total Income</div>
                    </div>
                    <div class="text-center p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.2);">
                        <div class="text-2xl font-bold">{{ analysis_results.analysis.summary.transaction_count }}</div>
                        <div class="text-sm opacity-80">Transactions</div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Spending Breakdown Chart -->
            {% if analysis_results.analysis.spending_breakdown %}
            <div class="mb-8 p-6 rounded-3xl" style="background-color: rgba(255, 255, 255, 0.9);">
                <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                    <span class="mr-3 text-3xl">🥧</span>
                    Spending Breakdown
                </h2>
                <div class="relative h-64">
                    <canvas id="spendingChart"></canvas>
                </div>
            </div>
            {% endif %}
            
            {% else %}
            <!-- No Analysis Available - Show Upload Prompt -->
            <div class="text-center py-12">
                <div class="backdrop-blur-sm rounded-3xl p-8" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                    <span class="text-6xl block mb-4">📊</span>
                    <h2 class="text-2xl font-bold mb-4">No Analysis Yet</h2>
                    <p class="mb-6 opacity-80">Upload a bank statement to see your personalized spending insights here!</p>
                    <a href="/home" class="inline-block px-6 py-3 rounded-lg font-semibold text-white brain-gradient hover:shadow-lg transition-all duration-200">
                        📄 Upload Statement
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Static Demo Content (fallback) -->
            <!-- Key Insights Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Spending Momentum -->
                <div class="backdrop-blur-sm rounded-3xl p-6 card-hover" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-3xl">🚀</span>
                        <div class="text-right">
                            <div class="text-sm opacity-80">Spending Momentum</div>
                            <div class="text-2xl font-bold">Steady</div>
                        </div>
                    </div>
                    <div class="text-xs opacity-80">No unusual patterns detected</div>
                </div>

                <!-- ADHD Pattern Score -->
                <div class="backdrop-blur-sm rounded-3xl p-6 card-hover" style="background-color: rgba(143, 11, 19, 0.9); color: #EFDFC5;">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-3xl">🧠</span>
                        <div class="text-right">
                            <div class="text-sm opacity-80">Pattern Awareness</div>
                            <div class="text-2xl font-bold">Good</div>
                        </div>
                    </div>
                    <div class="text-xs opacity-80">Impulse purchases well-managed</div>
                </div>

                <!-- Predictability -->
                <div class="backdrop-blur-sm rounded-3xl p-6 card-hover" style="background-color: rgba(37, 43, 43, 0.9); color: #EFDFC5;">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-3xl">📊</span>
                        <div class="text-right">
                            <div class="text-sm opacity-80">Budget Predictability</div>
                            <div class="text-2xl font-bold">78%</div>
                        </div>
                    </div>
                    <div class="text-xs opacity-80">Your spending is fairly consistent</div>
                </div>
            </div>

            <!-- Main Insights Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column -->
                <div class="space-y-8">
                    <!-- Spending Patterns -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">🧠</span>
                            Spending Patterns
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Impulse Control Insight -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(124, 236, 134, 0.2); border-left: 4px solid #7CEC86;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">🎯</span>
                                    <div>
                                        <h3 class="font-semibold" style="color: #380F17;">Great Impulse Control!</h3>
                                        <p class="text-sm mt-1" style="color: #4C4F54;">You've had only 2 impulse purchases this month, down from 7 last month. Your "pause before purchase" strategy is working!</p>
                                        <div class="mt-2 text-xs" style="color: #7CEC86;">💚 Positive reinforcement: You're building great new habits!</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hyperfocus Spending -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(255, 193, 7, 0.2); border-left: 4px solid #FFC107;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">🔍</span>
                                    <div>
                                        <h3 class="font-semibold" style="color: #380F17;">Focused Interest Alert</h3>
                                        <p class="text-sm mt-1" style="color: #4C4F54;">Noticed 3 art supply purchases in a row last week. This might be a period of deep engagement with a hobby - totally normal!</p>
                                        <div class="mt-2 text-xs" style="color: #D97706;">💡 Tip: Set a monthly hobby budget to enjoy interests guilt-free</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Routine Building -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(139, 92, 246, 0.2); border-left: 4px solid #8B5CF6;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">📅</span>
                                    <div>
                                        <h3 class="font-semibold" style="color: #380F17;">Routine Building Success</h3>
                                        <p class="text-sm mt-1" style="color: #4C4F54;">You've maintained consistent grocery shopping on Sundays for 3 weeks. Routines help manage daily tasks more effectively!</p>
                                        <div class="mt-2 text-xs" style="color: #8B5CF6;">✨ Celebration: New healthy habits are forming!</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Spending Predictions -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">🔮</span>
                            Smart Predictions
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Month-end Projection -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold" style="color: #380F17;">Month-End Projection</h3>
                                    <span class="text-lg font-bold" style="color: #8F0B13;">$2,340</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                    <div class="h-3 rounded-full brain-gradient" style="width: 76%;"></div>
                                </div>
                                <p class="text-xs" style="color: #4C4F54;">Based on current patterns, you'll likely spend $2,340 total this month (under budget by $160)</p>
                            </div>

                            <!-- Subscription Reminder -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="font-semibold" style="color: #380F17;">Subscription Check</h3>
                                        <p class="text-sm" style="color: #4C4F54;">Netflix charge due in 3 days</p>
                                    </div>
                                    <button class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                                        Review
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-8">
                    <!-- Category Analysis -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">📈</span>
                            Category Trends
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Food & Dining Trend -->
                            <div class="flex items-center justify-between p-3 rounded-xl" style="background-color: rgba(239, 223, 197, 0.6);">
                                <div class="flex items-center space-x-3">
                                    <span class="text-xl">🍕</span>
                                    <div>
                                        <h4 class="font-semibold text-sm" style="color: #380F17;">Food & Dining</h4>
                                        <p class="text-xs" style="color: #4C4F54;">↓ 15% from last month</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold" style="color: #7CEC86;">$542</div>
                                    <div class="text-xs" style="color: #4C4F54;">Great progress!</div>
                                </div>
                            </div>

                            <!-- Transportation -->
                            <div class="flex items-center justify-between p-3 rounded-xl" style="background-color: rgba(239, 223, 197, 0.6);">
                                <div class="flex items-center space-x-3">
                                    <span class="text-xl">🚗</span>
                                    <div>
                                        <h4 class="font-semibold text-sm" style="color: #380F17;">Transportation</h4>
                                        <p class="text-xs" style="color: #4C4F54;">↑ 8% from last month</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold" style="color: #8F0B13;">$289</div>
                                    <div class="text-xs" style="color: #4C4F54;">Gas prices up</div>
                                </div>
                            </div>

                            <!-- Entertainment -->
                            <div class="flex items-center justify-between p-3 rounded-xl" style="background-color: rgba(239, 223, 197, 0.6);">
                                <div class="flex items-center space-x-3">
                                    <span class="text-xl">🎮</span>
                                    <div>
                                        <h4 class="font-semibold text-sm" style="color: #380F17;">Entertainment</h4>
                                        <p class="text-xs" style="color: #4C4F54;">↔ Stable</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold" style="color: #252B2B;">$156</div>
                                    <div class="text-xs" style="color: #4C4F54;">Well managed</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unusual Activity -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">👀</span>
                            Unusual Activity
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Large Purchase -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(255, 193, 7, 0.2); border-left: 4px solid #FFC107;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">💰</span>
                                    <div>
                                        <h3 class="font-semibold" style="color: #380F17;">Large Purchase Detected</h3>
                                        <p class="text-sm mt-1" style="color: #4C4F54;">$450 at Best Buy on Dec 20th - much higher than your usual electronics spending of $50/month</p>
                                        <button class="mt-2 text-xs font-semibold px-3 py-1 rounded-lg" style="background-color: #380F17; color: #EFDFC5;">
                                            Categorize
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- New Merchant -->
                            <div class="p-4 rounded-2xl" style="background-color: rgba(59, 130, 246, 0.2); border-left: 4px solid #3B82F6;">
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl">🏪</span>
                                    <div>
                                        <h3 class="font-semibold" style="color: #380F17;">New Store Discovered</h3>
                                        <p class="text-sm mt-1" style="color: #4C4F54;">First purchase at "Trader Joe's" - $67 grocery trip. This could be a great budget-friendly option!</p>
                                        <div class="mt-2 text-xs" style="color: #3B82F6;">💡 Tip: Compare with your usual grocery costs</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Smart Money Tips -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="mr-3 text-2xl">🧠</span>
                            Smart Money Tip
                        </h3>
                        <div class="text-sm leading-relaxed">
                            <p class="mb-3">🎨 <strong>Creative Interest Budgeting:</strong> You spent $67 on art supplies this week during a creative period.</p>
                            <p class="text-xs opacity-80">This is totally normal! Consider setting aside a "creative fund" of $50-100/month for when inspiration strikes. Everyone needs creative outlets!</p>
                            <button class="mt-3 px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #EFDFC5; color: #380F17;">
                                Set Up Fund
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-8 text-center animate-fadeIn">
        <div class="max-w-4xl mx-auto px-4">
            <p class="text-sm" style="color: #4C4F54;">
                BrainBudget - Making budgeting accessible | powered by <span class="font-semibold" style="color: #8F0B13;">Niostudio</span>
            </p>
        </div>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if has_analysis and analysis_results and analysis_results.analysis.spending_breakdown %}
    // Initialize spending breakdown chart with real data
    const ctx = document.getElementById('spendingChart');
    if (ctx) {
        const spendingData = {{ analysis_results.analysis.spending_breakdown | tojson }};
        const categories = Object.keys(spendingData);
        const amounts = Object.values(spendingData);
        
        // Generate colors for each category
        const colors = [
            '#380F17', '#8F0B13', '#252B2B', '#4C4F54', 
            '#7CEC86', '#FFC107', '#8B5CF6', '#3B82F6'
        ];
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: categories,
                datasets: [{
                    data: amounts,
                    backgroundColor: colors.slice(0, categories.length),
                    borderWidth: 2,
                    borderColor: '#EFDFC5'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12
                            },
                            color: '#380F17'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = amounts.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    duration: 1500
                }
            }
        });
    }
    {% endif %}
    
    // Load insights data
    loadInsights();
    
    // Refresh insights periodically
    setInterval(loadInsights, 300000); // Every 5 minutes
    
    function loadInsights() {
        // Load spending pattern analysis
        fetch('/api/insights/spending-patterns')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSpendingPatterns(data.patterns);
                }
            })
            .catch(error => {
                console.log('Using demo spending pattern data');
            });
        
        // Load spending predictions
        fetch('/api/insights/predictions')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updatePredictions(data.predictions);
                }
            })
            .catch(error => {
                console.log('Using demo prediction data');
            });
        
        // Load category trends
        fetch('/api/insights/category-trends')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateCategoryTrends(data.trends);
                }
            })
            .catch(error => {
                console.log('Using demo category trend data');
            });
        
        // Load anomaly detection
        fetch('/api/insights/anomalies')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAnomalies(data.anomalies);
                }
            })
            .catch(error => {
                console.log('Using demo anomaly data');
            });
    }
    
    function updateSpendingPatterns(patterns) {
        // Update spending pattern analysis
        console.log('Spending patterns loaded:', patterns);
    }
    
    function updatePredictions(predictions) {
        // Update spending predictions
        console.log('Predictions loaded:', predictions);
    }
    
    function updateCategoryTrends(trends) {
        // Update category trend analysis
        console.log('Category trends loaded:', trends);
    }
    
    function updateAnomalies(anomalies) {
        // Update unusual activity detection
        console.log('Anomalies loaded:', anomalies);
    }
    
    // ADHD-friendly gentle animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe cards for entrance animations
    document.querySelectorAll('.card-hover').forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
    
    // Positive reinforcement system - celebrate positive insights
    setTimeout(() => {
        const positiveInsights = document.querySelectorAll('[style*="rgba(124, 236, 134, 0.2)"]');
        positiveInsights.forEach(insight => {
            insight.addEventListener('mouseenter', () => {
                showSuccessToast('🎉 Great job! Your mindful spending is paying off!');
            }, { once: true });
        });
    }, 2000);
});
</script>
{% endblock %}
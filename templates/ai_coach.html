{% extends "base.html" %}

{% block title %}AI Coach - BrainBudget{% endblock %}

{% block content %}
<!-- AI Coach Page -->
<div class="min-h-screen" style="background-color: #EFDFC5;">
    <!-- Navigation Header -->
    <header class="absolute top-4 left-4 right-4 z-10 animate-fadeIn">
        <div class="flex justify-between items-center">
            <div class="flex space-x-8">
                <a href="/home" class="flex items-center space-x-2 hover:opacity-80 transition-colors" style="color: #252B2B;">
                    <span>üè†</span>
                    <span>Home</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Navigation links removed - only on homepage -->
            </div>
        </div>
    </header>

    <!-- Header Section -->
    <div class="relative py-16 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <div class="mb-6">
                <span class="text-6xl">ü§ñ</span>
            </div>
            <div class="inline-block px-8 py-4 rounded-full brain-gradient mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-white">
                    AI Coach
                </h1>
            </div>
            <p class="text-lg max-w-2xl mx-auto leading-relaxed" style="color: #252B2B;">
                Personal financial coaching that understands your challenges and strengths. Get support, accountability, and guidance tailored to your unique needs.
            </p>
        </div>
    </div>

    <!-- AI Coach Content -->
    <div class="py-12 px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Chat Interface -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Main Chat Area -->
                <div class="lg:col-span-3">
                    <div class="backdrop-blur-sm rounded-3xl p-6 h-[600px] flex flex-col" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <!-- Chat Header -->
                        <div class="flex items-center justify-between mb-6 pb-4 border-b" style="border-color: rgba(56, 15, 23, 0.1);">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center brain-gradient">
                                    <span class="text-white text-xl">ü§ñ</span>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold" style="color: #380F17;">Personal Financial Coach</h3>
                                    <p class="text-sm" style="color: #4C4F54;" id="coach-status">Ready to help with your finances</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="startNewConversation()" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                                    üîÑ New Chat
                                </button>
                                <button onclick="showHistory()" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #4C4F54; color: #EFDFC5;">
                                    üìö History
                                </button>
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div id="messages-container" class="flex-1 overflow-y-auto space-y-4 mb-6">
                            <!-- Initial loading message -->
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                                    <span class="text-white text-sm">ü§ñ</span>
                                </div>
                                <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                    <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                                    <p style="color: #252B2B;">Loading your personal AI coach... üîÑ</p>
                                </div>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="border-t pt-4" style="border-color: rgba(56, 15, 23, 0.1);">
                            <div class="flex space-x-3">
                                <input 
                                    type="text" 
                                    id="user-input" 
                                    placeholder="Ask your AI coach anything about managing money..."
                                    class="flex-1 p-3 rounded-xl border focus:outline-none focus:ring-2"
                                    style="border-color: #380F17; focus:ring-color: #380F17;"
                                    onkeypress="handleKeyPress(event)"
                                >
                                <button 
                                    onclick="sendMessage()" 
                                    class="px-6 py-3 rounded-xl font-semibold transition-colors brain-gradient text-white hover:shadow-lg"
                                >
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="space-y-6">
                    <!-- Coach Specialties -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">üéØ</span>
                            I Specialize In
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center space-x-3 p-2 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <span class="text-lg">üß†</span>
                                <span style="color: #380F17;">Smart budgeting strategies</span>
                            </div>
                            <div class="flex items-center space-x-3 p-2 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <span class="text-lg">‚ö°</span>
                                <span style="color: #380F17;">Executive function support</span>
                            </div>
                            <div class="flex items-center space-x-3 p-2 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <span class="text-lg">üõí</span>
                                <span style="color: #380F17;">Impulse purchase management</span>
                            </div>
                            <div class="flex items-center space-x-3 p-2 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <span class="text-lg">üéâ</span>
                                <span style="color: #380F17;">Dopamine-driven motivation</span>
                            </div>
                            <div class="flex items-center space-x-3 p-2 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <span class="text-lg">üìä</span>
                                <span style="color: #380F17;">Goal flexibility & adaptation</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">‚ö°</span>
                            Quick Help
                        </h3>
                        <div class="space-y-3">
                            <button onclick="sendQuickMessage('Help me create a budget that works with my ADHD brain')" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #380F17; color: #EFDFC5;">
                                üí∞ Budget Setup
                            </button>
                            <button onclick="sendQuickMessage('I just made an impulse purchase and feel guilty about it')" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #8F0B13; color: #EFDFC5;">
                                üõçÔ∏è Impulse Purchase Support
                            </button>
                            <button onclick="sendQuickMessage('How can I remember to check my spending regularly?')" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #252B2B; color: #EFDFC5;">
                                üîî Memory Strategies
                            </button>
                        </div>
                    </div>

                    <!-- Conversation History -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">üìö</span>
                            Recent Topics
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="p-2 rounded-lg cursor-pointer hover:shadow-md transition-colors" style="background-color: rgba(239, 223, 197, 0.6);">
                                <p class="font-semibold" style="color: #380F17;">Emergency Fund Strategy</p>
                                <p class="text-xs" style="color: #4C4F54;">Yesterday ‚Ä¢ 15 min conversation</p>
                            </div>
                            <div class="p-2 rounded-lg cursor-pointer hover:shadow-md transition-colors" style="background-color: rgba(239, 223, 197, 0.6);">
                                <p class="font-semibold" style="color: #380F17;">Hyperfocus Spending</p>
                                <p class="text-xs" style="color: #4C4F54;">3 days ago ‚Ä¢ 8 min conversation</p>
                            </div>
                            <div class="p-2 rounded-lg cursor-pointer hover:shadow-md transition-colors" style="background-color: rgba(239, 223, 197, 0.6);">
                                <p class="font-semibold" style="color: #380F17;">Grocery Budget Tips</p>
                                <p class="text-xs" style="color: #4C4F54;">1 week ago ‚Ä¢ 12 min conversation</p>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Reminder Widget -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="mr-3 text-2xl">üíú</span>
                            Daily Reminder
                        </h3>
                        <div class="text-sm leading-relaxed">
                            <p class="mb-3">üß† <strong>You've Got This:</strong> Everyone's financial journey is unique and personal.</p>
                            <p class="text-xs opacity-80">Financial management can be challenging, but that doesn't mean you can't succeed. I'm here to help you find strategies that work for you.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-8 text-center animate-fadeIn">
        <div class="max-w-4xl mx-auto px-4">
            <p class="text-sm" style="color: #4C4F54;">
                BrainBudget - Making budgeting fun | powered by <span class="font-semibold" style="color: #8F0B13;">Niostudio</span>
            </p>
        </div>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let currentSessionId = null;
    let isLoading = false;
    let firebaseCheckAttempts = 0;
    let maxFirebaseChecks = 10; // Max 10 seconds to wait for Firebase
    
    // Initialize chat interface
    initializeChat();
    
    function initializeChat() {
        // Set up chat functionality
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Check authentication and start session
        checkAuthAndStartSession();
    }
    
    function checkAuthAndStartSession() {
        console.log('Checking auth and starting session...');
        
        // Check if user is authenticated
        if (window.firebase && window.firebase.auth) {
            console.log('Firebase loaded, checking auth state...');
            window.firebase.auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('User is authenticated:', user.uid);
                    // User is signed in, start conversation session
                    startNewConversationSession();
                } else {
                    console.log('User is not authenticated');
                    // User is not signed in, show login prompt
                    showLoginPrompt();
                }
            });
        } else {
            firebaseCheckAttempts++;
            if (firebaseCheckAttempts < maxFirebaseChecks) {
                console.log(`Firebase not loaded yet (attempt ${firebaseCheckAttempts}/${maxFirebaseChecks}), retrying in 1 second...`);
                setTimeout(checkAuthAndStartSession, 1000); // Retry if Firebase not loaded yet
            } else {
                console.error('Firebase failed to load after maximum attempts, showing fallback');
                showFirebaseError();
            }
        }
    }
    
    function showLoginPrompt() {
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                    <span class="text-white text-sm">ü§ñ</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                    <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                    <p style="color: #252B2B;">Hi there! I'd love to help you with your finances, but first you'll need to log in so I can provide personalized guidance. üîê</p>
                    <div class="mt-3">
                        <a href="/auth/login" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5; text-decoration: none;">
                            Log In to Continue
                        </a>
                    </div>
                </div>
            </div>
        `;
        
        // Disable input
        document.getElementById('user-input').disabled = true;
        document.getElementById('user-input').placeholder = "Please log in to chat with your AI coach...";
    }
    
    function showFirebaseError() {
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                    <span class="text-white text-sm">ü§ñ</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                    <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                    <p style="color: #252B2B;">I'm having trouble connecting right now. Please refresh the page or try again in a moment! üîÑ</p>
                    <div class="mt-3">
                        <button onclick="location.reload()" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                            Refresh Page
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Disable input
        document.getElementById('user-input').disabled = true;
        document.getElementById('user-input').placeholder = "Connection error - please refresh the page...";
    }
    
    async function startNewConversationSession() {
        try {
            const user = window.firebase.auth.currentUser;
            if (!user) return;
            
            const token = await user.getIdToken();
            
            const response = await fetch('/api/coach/start', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentSessionId = data.session_id;
                console.log('Started new AI coach session:', currentSessionId);
                
                // Enable input
                document.getElementById('user-input').disabled = false;
                document.getElementById('user-input').placeholder = "Ask your AI coach anything about managing money...";
                
                // Load conversation history if session already has messages
                loadCurrentSessionHistory();
                
                // Update coach status
                document.getElementById('coach-status').textContent = 'Ready to help with your finances';
                
                showSuccessToast('ü§ñ Your AI coach is ready to help!');
            } else {
                console.error('Failed to start AI coach session:', data.message);
                showErrorToast('Had trouble starting AI coach session. Please try again!');
                
                // Show fallback message
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                            <span class="text-white text-sm">ü§ñ</span>
                        </div>
                        <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                            <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                            <p style="color: #252B2B;">I'm having some technical difficulties starting our conversation. Please try refreshing the page! üîß</p>
                            <div class="mt-3">
                                <button onclick="location.reload()" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                                    Refresh & Try Again
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error starting AI coach session:', error);
            showErrorToast('Connection error. Please check your internet and try again!');
            
            // Show error message in chat
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                        <span class="text-white text-sm">ü§ñ</span>
                    </div>
                    <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                        <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                        <p style="color: #252B2B;">I'm having trouble connecting to the server. Please check your internet connection and try again! üåê</p>
                        <div class="mt-3">
                            <button onclick="location.reload()" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                                Refresh Page
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    async function loadCurrentSessionHistory() {
        if (!currentSessionId) return;
        
        try {
            const user = window.firebase.auth.currentUser;
            if (!user) return;
            
            const token = await user.getIdToken();
            
            const response = await fetch(`/api/coach/history/${currentSessionId}?limit=10`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success && data.history.length > 0) {
                // Clear current messages
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';
                
                // Add history messages
                data.history.forEach(msg => {
                    if (msg.role === 'user') {
                        addUserMessage(msg.content, false);
                    } else {
                        addCoachResponse(msg.content, false);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading conversation history:', error);
        }
    }
    
    // Chat functions
    window.sendMessage = async function() {
        const input = document.getElementById('user-input');
        const message = input.value.trim();
        
        if (!message || isLoading || !currentSessionId) return;
        
        // Add user message to chat
        addUserMessage(message);
        
        // Clear input
        input.value = '';
        
        // Show typing indicator
        showTypingIndicator();
        isLoading = true;
        
        try {
            const user = window.firebase.auth.currentUser;
            if (!user) {
                hideTypingIndicator();
                isLoading = false;
                showErrorToast('Please log in to continue chatting!');
                return;
            }
            
            const token = await user.getIdToken();
            
            const response = await fetch(`/api/coach/chat/${currentSessionId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            hideTypingIndicator();
            isLoading = false;
            
            if (data.success) {
                addCoachResponse(data.response.content);
                
                // Update coach status with session info
                if (data.response.session_info) {
                    document.getElementById('coach-status').textContent = 
                        `Conversation: ${data.response.session_info.total_messages} messages`;
                }
            } else {
                console.error('AI coach API error:', data.message);
                addCoachResponse("I apologize, but I'm having trouble responding right now. Please try asking again! üíô");
            }
        } catch (error) {
            console.error('Error sending message to AI coach:', error);
            hideTypingIndicator();
            isLoading = false;
            addCoachResponse("I'm experiencing some technical difficulties. Let me try to help you in a moment! üîß");
        }
    };
    
    window.sendQuickMessage = function(message) {
        if (isLoading || !currentSessionId) return;
        document.getElementById('user-input').value = message;
        sendMessage();
    };
    
    window.handleKeyPress = function(event) {
        if (event.key === 'Enter' && !isLoading) {
            sendMessage();
        }
    };
    
    function addUserMessage(message, scroll = true) {
        const messagesContainer = document.getElementById('messages-container');
        const messageElement = document.createElement('div');
        messageElement.className = 'flex items-start space-x-3 justify-end';
        messageElement.innerHTML = `
            <div class="flex-1 max-w-xs p-4 rounded-2xl" style="background-color: rgba(56, 15, 23, 0.1);">
                <p style="color: #252B2B;">${escapeHtml(message)}</p>
            </div>
            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: #8F0B13;">
                <span class="text-white text-sm">üë§</span>
            </div>
        `;
        messagesContainer.appendChild(messageElement);
        
        if (scroll) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    function addCoachResponse(response, scroll = true) {
        const messagesContainer = document.getElementById('messages-container');
        const messageElement = document.createElement('div');
        messageElement.className = 'flex items-start space-x-3';
        messageElement.innerHTML = `
            <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                <span class="text-white text-sm">ü§ñ</span>
            </div>
            <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                <p style="color: #252B2B;">${formatCoachResponse(response)}</p>
            </div>
        `;
        messagesContainer.appendChild(messageElement);
        
        if (scroll) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    function showTypingIndicator() {
        const messagesContainer = document.getElementById('messages-container');
        const typingElement = document.createElement('div');
        typingElement.id = 'typing-indicator';
        typingElement.className = 'flex items-start space-x-3';
        typingElement.innerHTML = `
            <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                <span class="text-white text-sm">ü§ñ</span>
            </div>
            <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                <div class="flex space-x-1">
                    <div class="w-2 h-2 rounded-full animate-pulse" style="background-color: #380F17;"></div>
                    <div class="w-2 h-2 rounded-full animate-pulse" style="background-color: #380F17; animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 rounded-full animate-pulse" style="background-color: #380F17; animation-delay: 0.4s;"></div>
                </div>
            </div>
        `;
        messagesContainer.appendChild(typingElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatCoachResponse(response) {
        // Basic formatting for AI responses
        return escapeHtml(response)
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }
    
    // Additional functions
    window.startNewConversation = function() {
        if (isLoading) return;
        
        // Reset session and start fresh
        currentSessionId = null;
        startNewConversationSession();
        
        // Clear messages
        document.getElementById('messages-container').innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center brain-gradient">
                    <span class="text-white text-sm">ü§ñ</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                    <p class="text-sm font-semibold mb-2" style="color: #380F17;">Your AI Coach</p>
                    <p style="color: #252B2B;">Starting a fresh conversation... üîÑ</p>
                </div>
            </div>
        `;
        
        showSuccessToast('üîÑ Started new conversation with your AI coach!');
    };
    
    window.showHistory = function() {
        showSuccessToast('üìö Conversation history feature coming soon! You\'ll be able to review and continue previous coaching sessions.');
    };
    
    // Auto-focus on input when page loads (if enabled)
    setTimeout(() => {
        const input = document.getElementById('user-input');
        if (!input.disabled) {
            input.focus();
        }
    }, 1000);
});
</script>
{% endblock %}
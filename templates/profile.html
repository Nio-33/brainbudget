{% extends "base.html" %}

{% block title %}Profile - BrainBudget{% endblock %}

{% block head %}
<!-- Cache busting for development -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<!-- Template version for debugging -->
<meta name="template-version" content="password-fix-v3.0-{{ current_timestamp or '2025-09-18-21:55' }}">
{% endblock %}

{% block content %}
<!-- Profile Page -->
<div class="min-h-screen" style="background-color: #EFDFC5;">
    <!-- Navigation Header -->
    <header class="absolute top-4 left-4 right-4 z-10 animate-fadeIn">
        <div class="flex justify-between items-center">
            <div class="flex space-x-8">
                <a href="/home" class="flex items-center space-x-2 hover:opacity-80 transition-colors" style="color: #252B2B;">
                    <span>üè†</span>
                    <span>Home</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Navigation links removed - only on homepage -->
            </div>
        </div>
    </header>

    <!-- Header Section -->
    <div class="relative py-16 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <div class="mb-6">
                <span class="text-6xl">üë§</span>
            </div>
            <div class="inline-block px-8 py-4 rounded-full brain-gradient mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-white">
                    Profile
                </h1>
            </div>
            <p class="text-lg max-w-2xl mx-auto leading-relaxed" style="color: #252B2B;">
                Your personalized BrainBudget profile with user preferences, achievements, and financial journey insights.
            </p>
        </div>
    </div>

    <!-- Profile Content -->
    <div class="py-12 px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Profile Header Card -->
            <div class="backdrop-blur-sm rounded-3xl p-8 mb-8 card-hover" style="background: linear-gradient(135deg, #380F17 0%, #8F0B13 100%); color: #EFDFC5;">
                <div class="flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8">
                    <!-- Profile Avatar -->
                    <div class="w-32 h-32 rounded-full flex items-center justify-center text-6xl" style="background-color: #EFDFC5; color: #380F17;">
                        üß†
                    </div>
                    
                    <!-- Profile Info -->
                    <div class="flex-1 text-center md:text-left">
                        <h2 id="profile-display-name" class="text-3xl font-bold mb-2">Loading...</h2>
                        <p id="profile-title" class="text-lg opacity-90 mb-4">Financial Warrior</p>
                        <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                            <span class="px-4 py-2 rounded-full text-sm font-semibold" style="background-color: #EFDFC5; color: #380F17;">
                                üéØ Goal Achiever
                            </span>
                            <span class="px-4 py-2 rounded-full text-sm font-semibold" style="background-color: rgba(239, 223, 197, 0.2); color: #EFDFC5;">
                                üìä Budget Master
                            </span>
                            <span class="px-4 py-2 rounded-full text-sm font-semibold" style="background-color: rgba(239, 223, 197, 0.2); color: #EFDFC5;">
                                üß† Self-Aware
                            </span>
                        </div>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div class="text-center">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div id="days-active" class="text-2xl font-bold">1</div>
                                <div class="text-sm opacity-80">Days Active</div>
                            </div>
                            <div>
                                <div id="goals-achieved" class="text-2xl font-bold">0</div>
                                <div class="text-sm opacity-80">Goals Achieved</div>
                            </div>
                            <div>
                                <div id="user-score" class="text-2xl font-bold">75%</div>
                                <div class="text-sm opacity-80">User Score</div>
                            </div>
                            <div>
                                <div id="total-saved" class="text-2xl font-bold">$0</div>
                                <div class="text-sm opacity-80">Saved Total</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Profile Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column - Profile Details -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Personal Information -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold flex items-center" style="color: #380F17;">
                                <span class="mr-3 text-3xl">üìù</span>
                                Personal Information
                            </h2>
                            <button onclick="editProfile()" class="px-4 py-2 rounded-lg font-semibold transition-colors" style="background-color: #380F17; color: #EFDFC5;">
                                ‚úèÔ∏è Edit Profile
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Basic Info -->
                            <div class="space-y-4">
                                <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                    <label class="text-sm font-semibold" style="color: #380F17;">Full Name</label>
                                    <p id="profile-full-name" class="mt-1" style="color: #252B2B;">Loading...</p>
                                </div>
                                
                                <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                    <label class="text-sm font-semibold" style="color: #380F17;">Email</label>
                                    <p id="profile-email" class="mt-1" style="color: #252B2B;">Loading...</p>
                                </div>
                                
                                <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                    <label class="text-sm font-semibold" style="color: #380F17;">Join Date</label>
                                    <p id="profile-join-date" class="mt-1" style="color: #252B2B;">Loading...</p>
                                </div>
                            </div>
                            
                            <!-- User Profile -->
                            <div class="space-y-4">
                                <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                    <label class="text-sm font-semibold" style="color: #380F17;">Profile Type</label>
                                    <p id="profile-type" class="mt-1" style="color: #252B2B;">Balanced User</p>
                                </div>
                                
                                <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                    <label class="text-sm font-semibold" style="color: #380F17;">Primary Challenges</label>
                                    <p id="profile-challenges" class="mt-1 text-sm" style="color: #252B2B;">Budget tracking, Goal setting</p>
                                </div>
                                
                                <div class="p-4 rounded-2xl" style="background-color: rgba(239, 223, 197, 0.8);">
                                    <label class="text-sm font-semibold" style="color: #380F17;">Preferred Learning Style</label>
                                    <p id="profile-learning-style" class="mt-1" style="color: #252B2B;">Visual + Interactive</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Journey Timeline -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">üìà</span>
                            Your Financial Journey
                        </h2>
                        
                        <div id="timeline-container" class="space-y-6">
                            <!-- Timeline items will be loaded dynamically -->
                            <div class="text-center py-8">
                                <div class="text-2xl mb-2">üìä</div>
                                <p class="text-gray-600">Loading your financial journey...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Achievement Gallery -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-3xl">üèÜ</span>
                            Achievements & Badges
                        </h2>
                        
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Achievements will be loaded dynamically -->
                            <div class="col-span-2 md:col-span-4 text-center py-8">
                                <div class="text-2xl mb-2">üèÜ</div>
                                <p class="text-gray-600">Loading your achievements...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="space-y-6">
                    <!-- Quick Stats -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">üìä</span>
                            Quick Stats
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <div>
                                    <p class="text-sm font-semibold" style="color: #380F17;">Total Saved</p>
                                    <p class="text-xs" style="color: #4C4F54;">Across all goals</p>
                                </div>
                                <span id="quick-total-saved" class="text-lg font-bold" style="color: #8F0B13;">$0</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <div>
                                    <p class="text-sm font-semibold" style="color: #380F17;">Avg Monthly Save</p>
                                    <p class="text-xs" style="color: #4C4F54;">Recent average</p>
                                </div>
                                <span id="quick-avg-save" class="text-lg font-bold" style="color: #8F0B13;">$0</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <div>
                                    <p class="text-sm font-semibold" style="color: #380F17;">User Score</p>
                                    <p class="text-xs" style="color: #4C4F54;">Smart habits</p>
                                </div>
                                <span id="quick-user-score" class="text-lg font-bold" style="color: #7CEC86;">75%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Account Actions -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">‚öôÔ∏è</span>
                            Account Actions
                        </h3>
                        <div class="space-y-3">
                            <button onclick="updatePassword()" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #380F17; color: #EFDFC5;" title="Password change modal - v2.0">
                                üîê Change Password
                            </button>
                            <button onclick="exportData()" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #8F0B13; color: #EFDFC5;">
                                üì§ Export My Data
                            </button>
                            <button onclick="managePreferences()" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #252B2B; color: #EFDFC5;">
                                üéõÔ∏è Preferences
                            </button>
                            <button onclick="logout()" class="w-full p-3 rounded-xl font-semibold transition-colors hover:shadow-md text-left" style="background-color: #8F0B13; color: #EFDFC5; border: 2px solid #380F17;">
                                üö™ Logout
                            </button>
                        </div>
                    </div>

                    <!-- Privacy & Security -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid #380F17;">
                        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #380F17;">
                            <span class="mr-3 text-2xl">üõ°Ô∏è</span>
                            Privacy & Security
                        </h3>
                        <div class="space-y-4 text-sm">
                            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: rgba(124, 236, 134, 0.2);">
                                <div>
                                    <p class="font-semibold" style="color: #380F17;">Two-Factor Auth</p>
                                    <p class="text-xs" style="color: #4C4F54;">Extra security layer</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full" style="background-color: #7CEC86; color: white;">‚úì Enabled</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: rgba(239, 223, 197, 0.6);">
                                <div>
                                    <p class="font-semibold" style="color: #380F17;">Data Encryption</p>
                                    <p class="text-xs" style="color: #4C4F54;">All data encrypted</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full" style="background-color: #7CEC86; color: white;">‚úì Active</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Support -->
                    <div class="backdrop-blur-sm rounded-3xl p-6" style="background-color: rgba(56, 15, 23, 0.9); color: #EFDFC5;">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="mr-3 text-2xl">üß†</span>
                            Progress Journey
                        </h3>
                        <div class="text-sm leading-relaxed">
                            <p id="progress-summary" class="mb-3">üåü <strong>1 day</strong> of building smart financial habits!</p>
                            <p class="text-xs opacity-80 mb-4">Your brain is creating new neural pathways for money management. That's incredible progress!</p>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs">Impulse Control</span>
                                    <span class="text-xs">92%</span>
                                </div>
                                <div class="w-full bg-gray-200 bg-opacity-30 rounded-full h-2">
                                    <div class="h-2 rounded-full" style="background-color: #EFDFC5; width: 92%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-8 text-center animate-fadeIn">
        <div class="max-w-4xl mx-auto px-4">
            <p class="text-sm" style="color: #4C4F54;">
                BrainBudget - Making budgeting fun | powered by <span class="font-semibold" style="color: #8F0B13;">Niostudio</span>
            </p>
        </div>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script>
// Version check for debugging cache issues
console.log('üß† BrainBudget Profile Page JavaScript Loaded');
console.log('üìÖ Template Version: password-fix-v3.0-2025-09-18-21:55 - FUNCTIONS FIXED');
console.log('‚úÖ closePasswordModal and togglePasswordVisibility now globally accessible');
console.log('üîÑ If you still see errors, please hard refresh (Ctrl+F5 or Cmd+Shift+R)');

document.addEventListener('DOMContentLoaded', function() {
    // Load profile data
    loadProfileData();
    
    // Set up profile interactions
    setupProfileInteractions();
    
    function loadProfileData() {
        // Load user profile information
        fetch('/api/profile/info')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateProfileDisplay(data.profile);
                } else {
                    showError('Failed to load profile information');
                }
            })
            .catch(error => {
                console.error('Error loading profile:', error);
                showError('Unable to load profile data');
            });
        
        // Load user stats
        fetch('/api/profile/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateProfileStats(data.stats);
                }
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
        
        // Load user achievements
        fetch('/api/profile/achievements')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAchievements(data.achievements);
                }
            })
            .catch(error => {
                console.error('Error loading achievements:', error);
                showDefaultAchievements();
            });
        
        // Load financial journey timeline
        fetch('/api/profile/timeline')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTimeline(data.timeline);
                }
            })
            .catch(error => {
                console.error('Error loading timeline:', error);
                showDefaultTimeline();
            });
    }
    
    function updateProfileDisplay(profile) {
        // Update profile information
        document.getElementById('profile-display-name').textContent = profile.display_name || 'User';
        document.getElementById('profile-full-name').textContent = profile.display_name || 'User';
        document.getElementById('profile-email').textContent = profile.email || 'user@example.com';
        document.getElementById('profile-join-date').textContent = profile.join_date || 'Today';
        document.getElementById('profile-type').textContent = profile.profile_type || 'Balanced User';
        document.getElementById('profile-learning-style').textContent = profile.learning_style || 'Visual + Interactive';
        
        // Update challenges
        const challenges = Array.isArray(profile.primary_challenges) ? 
            profile.primary_challenges.join(', ') : 
            (profile.primary_challenges || 'Budget tracking, Goal setting');
        document.getElementById('profile-challenges').textContent = challenges;
        
        // Update profile picture if available
        if (profile.profile_picture) {
            // Add profile picture logic here
            console.log('Profile picture available:', profile.profile_picture);
        }
        
        console.log('Profile updated successfully');
    }
    
    function updateProfileStats(stats) {
        // Update header stats
        document.getElementById('days-active').textContent = stats.days_active || 1;
        document.getElementById('goals-achieved').textContent = stats.goals_achieved || 0;
        document.getElementById('user-score').textContent = (stats.user_score || 75) + '%';
        document.getElementById('total-saved').textContent = '$' + (stats.total_saved || 0).toLocaleString();
        
        // Update quick stats sidebar
        document.getElementById('quick-total-saved').textContent = '$' + (stats.total_saved || 0).toLocaleString();
        document.getElementById('quick-avg-save').textContent = '$' + (stats.avg_monthly_save || 0).toLocaleString();
        document.getElementById('quick-user-score').textContent = (stats.user_score || 75) + '%';
        
        // Update progress summary
        const daysText = stats.days_active === 1 ? 'day' : 'days';
        document.getElementById('progress-summary').innerHTML = 
            `üåü <strong>${stats.days_active || 1} ${daysText}</strong> of building smart financial habits!`;
    }
    
    function updateAchievements(achievements) {
        const container = document.getElementById('achievements-container');
        if (!achievements || achievements.length === 0) {
            showDefaultAchievements();
            return;
        }
        
        container.innerHTML = '';
        
        achievements.forEach(achievement => {
            const achievementEl = document.createElement('div');
            achievementEl.className = 'text-center p-4 rounded-2xl achievement-item cursor-pointer hover:scale-105 transition-transform';
            achievementEl.style.backgroundColor = getAchievementColor(achievement.color);
            
            achievementEl.innerHTML = `
                <div class="text-4xl mb-2">${achievement.icon}</div>
                <h3 class="text-sm font-semibold" style="color: #380F17;">${achievement.title}</h3>
                <p class="text-xs" style="color: #4C4F54;">${achievement.description}</p>
            `;
            
            achievementEl.addEventListener('click', () => {
                showSuccessToast(`üéâ ${achievement.title}: ${achievement.description}`);
            });
            
            container.appendChild(achievementEl);
        });
    }
    
    function updateTimeline(timeline) {
        const container = document.getElementById('timeline-container');
        if (!timeline || timeline.length === 0) {
            showDefaultTimeline();
            return;
        }
        
        container.innerHTML = '';
        
        timeline.forEach(event => {
            const eventEl = document.createElement('div');
            eventEl.className = 'flex items-start space-x-4';
            
            const statusColors = {
                'completed': '#7CEC86',
                'in_progress': '#FFC107',
                'upcoming': '#4C4F54'
            };
            
            const statusIcons = {
                'completed': '‚úÖ',
                'in_progress': 'üîÑ',
                'upcoming': 'üìÖ'
            };
            
            eventEl.innerHTML = `
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: ${statusColors[event.status] || '#4C4F54'};">
                    <span class="text-white text-lg">${statusIcons[event.status] || event.icon || 'üìç'}</span>
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold" style="color: #380F17;">${event.title}</h3>
                    <p class="text-sm" style="color: #4C4F54;">${event.description} ‚Ä¢ ${event.date}</p>
                    <div class="mt-2 px-3 py-1 rounded-full inline-block text-xs font-semibold" style="background-color: ${statusColors[event.status]}33; color: #380F17;">
                        ${event.icon || 'üéØ'} ${event.badge || 'Milestone'}
                    </div>
                </div>
            `;
            
            container.appendChild(eventEl);
        });
    }
    
    function showDefaultAchievements() {
        const container = document.getElementById('achievements-container');
        container.innerHTML = `
            <div class="text-center p-4 rounded-2xl" style="background-color: rgba(124, 236, 134, 0.2);">
                <div class="text-4xl mb-2">üéØ</div>
                <h3 class="text-sm font-semibold" style="color: #380F17;">Getting Started</h3>
                <p class="text-xs" style="color: #4C4F54;">Joined BrainBudget</p>
            </div>
            <div class="text-center p-4 rounded-2xl" style="background-color: rgba(255, 193, 7, 0.2);">
                <div class="text-4xl mb-2">üöÄ</div>
                <h3 class="text-sm font-semibold" style="color: #380F17;">First Steps</h3>
                <p class="text-xs" style="color: #4C4F54;">Upload your first statement</p>
            </div>
        `;
    }
    
    function showDefaultTimeline() {
        const container = document.getElementById('timeline-container');
        container.innerHTML = `
            <div class="flex items-start space-x-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: #7CEC86;">
                    <span class="text-white text-lg">üéâ</span>
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold" style="color: #380F17;">Joined BrainBudget</h3>
                    <p class="text-sm" style="color: #4C4F54;">Welcome to your smart budgeting journey!</p>
                    <div class="mt-2 px-3 py-1 rounded-full inline-block text-xs font-semibold" style="background-color: rgba(124, 236, 134, 0.2); color: #380F17;">
                        üéØ Welcome!
                    </div>
                </div>
            </div>
            <div class="flex items-start space-x-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: #FFC107;">
                    <span class="text-white text-lg">üìã</span>
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold" style="color: #380F17;">Upload Your First Statement</h3>
                    <p class="text-sm" style="color: #4C4F54;">Get your first financial insights</p>
                    <div class="mt-2 px-3 py-1 rounded-full inline-block text-xs font-semibold" style="background-color: rgba(255, 193, 7, 0.2); color: #380F17;">
                        üöÄ Next Step
                    </div>
                </div>
            </div>
        `;
    }
    
    function getAchievementColor(color) {
        const colors = {
            'green': 'rgba(124, 236, 134, 0.2)',
            'blue': 'rgba(59, 130, 246, 0.2)',
            'orange': 'rgba(255, 193, 7, 0.2)',
            'purple': 'rgba(139, 92, 246, 0.2)',
            'teal': 'rgba(20, 184, 166, 0.2)',
            'red': 'rgba(239, 68, 68, 0.2)'
        };
        return colors[color] || 'rgba(156, 163, 175, 0.2)';
    }
    
    function showError(message) {
        if (typeof showErrorToast === 'function') {
            showErrorToast(message);
        } else {
            console.error(message);
        }
    }
    
    function setupProfileInteractions() {
        // Add interactive elements
        const statCards = document.querySelectorAll('[style*="rgba(239, 223, 197, 0.6)"]');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'scale(1.02)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'scale(1)';
            });
        });
    }
    
    // Profile action functions
    window.editProfile = function() {
        showEditProfileModal();
    };
    
    function showEditProfileModal() {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.id = 'edit-profile-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        
        // Get current profile data
        const currentName = document.getElementById('profile-display-name').textContent || '';
        const nameParts = currentName.split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || '';
        const currentType = document.getElementById('profile-type').textContent || 'Balanced User';
        const currentStyle = document.getElementById('profile-learning-style').textContent || 'Visual + Interactive';
        
        modal.innerHTML = `
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 w-full">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold" style="color: #380F17;">Edit Profile</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="edit-profile-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">First Name</label>
                        <input type="text" id="edit-first-name" value="${firstName}" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">Last Name</label>
                        <input type="text" id="edit-last-name" value="${lastName}" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">Profile Type</label>
                        <select id="edit-profile-type" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="Balanced User" ${currentType === 'Balanced User' ? 'selected' : ''}>Balanced User</option>
                            <option value="Saver" ${currentType === 'Saver' ? 'selected' : ''}>Saver</option>
                            <option value="Spender" ${currentType === 'Spender' ? 'selected' : ''}>Spender</option>
                            <option value="Investor" ${currentType === 'Investor' ? 'selected' : ''}>Investor</option>
                            <option value="Budget Beginner" ${currentType === 'Budget Beginner' ? 'selected' : ''}>Budget Beginner</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">Learning Style</label>
                        <select id="edit-learning-style" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="Visual + Interactive" ${currentStyle === 'Visual + Interactive' ? 'selected' : ''}>Visual + Interactive</option>
                            <option value="Step-by-step" ${currentStyle === 'Step-by-step' ? 'selected' : ''}>Step-by-step</option>
                            <option value="Quick Overview" ${currentStyle === 'Quick Overview' ? 'selected' : ''}>Quick Overview</option>
                            <option value="Detailed Analysis" ${currentStyle === 'Detailed Analysis' ? 'selected' : ''}>Detailed Analysis</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">Primary Challenges</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="Budget tracking" class="challenge-checkbox mr-2">
                                <span class="text-sm">Budget tracking</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Goal setting" class="challenge-checkbox mr-2">
                                <span class="text-sm">Goal setting</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Impulse control" class="challenge-checkbox mr-2">
                                <span class="text-sm">Impulse control</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Saving money" class="challenge-checkbox mr-2">
                                <span class="text-sm">Saving money</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Time management" class="challenge-checkbox mr-2">
                                <span class="text-sm">Time management</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 py-3 px-4 rounded-lg font-semibold text-white transition-colors" 
                                style="background-color: #380F17;" id="save-profile-btn">
                            Save Changes
                        </button>
                        <button type="button" onclick="closeEditModal()" 
                                class="flex-1 py-3 px-4 rounded-lg font-semibold border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Set up form handling
        document.getElementById('edit-profile-form').addEventListener('submit', handleProfileSave);
        
        // Pre-check current challenges
        const currentChallenges = document.getElementById('profile-challenges').textContent.split(', ');
        document.querySelectorAll('.challenge-checkbox').forEach(checkbox => {
            if (currentChallenges.includes(checkbox.value)) {
                checkbox.checked = true;
            }
        });
    }
    
    window.closeEditModal = function() {
        const modal = document.getElementById('edit-profile-modal');
        if (modal) {
            modal.remove();
        }
    };
    
    function handleProfileSave(event) {
        event.preventDefault();
        
        const saveBtn = document.getElementById('save-profile-btn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;
        
        // Get form data
        const firstName = document.getElementById('edit-first-name').value.trim();
        const lastName = document.getElementById('edit-last-name').value.trim();
        const profileType = document.getElementById('edit-profile-type').value;
        const learningStyle = document.getElementById('edit-learning-style').value;
        
        // Get selected challenges
        const challenges = Array.from(document.querySelectorAll('.challenge-checkbox:checked'))
            .map(cb => cb.value);
        
        // Validate
        if (!firstName || !lastName) {
            showError('Please enter both first and last name');
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            return;
        }
        
        // Prepare data
        const profileData = {
            first_name: firstName,
            last_name: lastName,
            profile_type: profileType,
            learning_style: learningStyle,
            primary_challenges: challenges
        };
        
        // Send to API
        fetch('/api/profile/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(profileData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast('‚úÖ Profile updated successfully!');
                closeEditModal();
                // Reload profile data
                loadProfileData();
            } else {
                showError(data.error || 'Failed to update profile');
            }
        })
        .catch(error => {
            console.error('Error updating profile:', error);
            showError('Unable to update profile. Please try again.');
        })
        .finally(() => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        });
    }
    
    window.updatePassword = function() {
        console.log('üîê Password change button clicked - NEW VERSION LOADED');
        console.log('showPasswordChangeModal function exists:', typeof showPasswordChangeModal);
        try {
            showPasswordChangeModal();
        } catch (error) {
            console.error('Error calling showPasswordChangeModal:', error);
            // Fallback: show error message
            alert('Password change functionality is being loaded. Please refresh the page and try again.');
        }
    };
    
    function showPasswordChangeModal() {
        console.log('üîê showPasswordChangeModal() called - Creating password change modal');
        
        // Create modal overlay
        const modal = document.createElement('div');
        modal.id = 'password-change-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        
        modal.innerHTML = `
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 w-full">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold flex items-center" style="color: #380F17;">
                        <span class="mr-3 text-3xl">üîê</span>
                        Change Password
                    </h2>
                    <button onclick="closePasswordModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(124, 236, 134, 0.2);">
                    <div class="flex items-start space-x-3">
                        <span class="text-xl">üõ°Ô∏è</span>
                        <div>
                            <p class="font-semibold text-sm" style="color: #380F17;">Security First!</p>
                            <p class="text-xs" style="color: #4C4F54;">For your protection, we need to verify your current password before setting a new one.</p>
                        </div>
                    </div>
                </div>
                
                <form id="password-change-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">Current Password *</label>
                        <div class="relative">
                            <input type="password" id="current-password" 
                                   class="w-full p-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                   placeholder="Enter your current password" required>
                            <button type="button" onclick="togglePasswordVisibility('current-password')" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">New Password *</label>
                        <div class="relative">
                            <input type="password" id="new-password" 
                                   class="w-full p-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                   placeholder="Enter your new password" required minlength="8">
                            <button type="button" onclick="togglePasswordVisibility('new-password')" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <div id="password-strength" class="mt-2 text-xs"></div>
                        <p class="text-xs mt-1" style="color: #4C4F54;">üí° Use at least 8 characters with letters, numbers, and symbols</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: #380F17;">Confirm New Password *</label>
                        <div class="relative">
                            <input type="password" id="confirm-password" 
                                   class="w-full p-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                   placeholder="Confirm your new password" required>
                            <button type="button" onclick="togglePasswordVisibility('confirm-password')" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <div id="password-match" class="mt-2 text-xs"></div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 py-3 px-4 rounded-lg font-semibold text-white transition-colors" 
                                style="background-color: #380F17;" id="change-password-btn">
                            üîí Update Password
                        </button>
                        <button type="button" onclick="closePasswordModal()" 
                                class="flex-1 py-3 px-4 rounded-lg font-semibold border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Set up form handling and validation
        setupPasswordForm();
        
        // Add click outside to close functionality
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                console.log('üîê Clicked outside modal - closing');
                window.closePasswordModal();
            }
        });
        
        // Add ESC key to close functionality
        const handleEscKey = function(e) {
            if (e.key === 'Escape') {
                console.log('üîê ESC key pressed - closing modal');
                window.closePasswordModal();
                document.removeEventListener('keydown', handleEscKey);
            }
        };
        document.addEventListener('keydown', handleEscKey);
        
        // Store the escape handler for cleanup
        modal.escapeHandler = handleEscKey;
        
        // Focus the first input
        setTimeout(() => {
            document.getElementById('current-password').focus();
        }, 100);
    }
    
    // Global functions for modal interaction (accessible to onclick handlers)
    window.closePasswordModal = function() {
        console.log('üîê closePasswordModal() called - Closing modal');
        const modal = document.getElementById('password-change-modal');
        if (modal) {
            // Clean up event listeners
            if (modal.escapeHandler) {
                document.removeEventListener('keydown', modal.escapeHandler);
                console.log('üßπ ESC key listener cleaned up');
            }
            
            // Remove modal from DOM
            modal.remove();
            console.log('‚úÖ Password modal closed successfully');
        } else {
            console.warn('‚ö†Ô∏è Password modal not found');
        }
    };
    
    window.togglePasswordVisibility = function(inputId) {
        console.log('üëÅÔ∏è togglePasswordVisibility() called for:', inputId);
        try {
            const input = document.getElementById(inputId);
            if (!input) {
                console.error('‚ùå Input not found:', inputId);
                return;
            }
            
            const button = input.nextElementSibling;
            if (!button) {
                console.error('‚ùå Button not found for input:', inputId);
                return;
            }
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
                console.log('üëÅÔ∏è Password now visible for:', inputId);
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
                console.log('üôà Password now hidden for:', inputId);
            }
        } catch (error) {
            console.error('‚ùå Error toggling password visibility:', error);
        }
    };
    
    function setupPasswordForm() {
        const form = document.getElementById('password-change-form');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        
        // Set up password strength checking
        newPasswordInput.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            if (confirmPasswordInput.value) {
                checkPasswordMatch();
            }
        });
        
        // Set up password match checking
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        
        // Set up form submission
        form.addEventListener('submit', handlePasswordChangeSubmit);
    }
    
    function checkPasswordStrength(password) {
        const strengthDiv = document.getElementById('password-strength');
        
        if (!password) {
            strengthDiv.innerHTML = '';
            return;
        }
        
        let score = 0;
        let feedback = [];
        
        // Length check
        if (password.length >= 8) score++;
        else feedback.push('at least 8 characters');
        
        // Lowercase check
        if (/[a-z]/.test(password)) score++;
        else feedback.push('lowercase letters');
        
        // Uppercase check
        if (/[A-Z]/.test(password)) score++;
        else feedback.push('uppercase letters');
        
        // Number check
        if (/\d/.test(password)) score++;
        else feedback.push('numbers');
        
        // Special character check
        if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) score++;
        else feedback.push('special characters');
        
        if (score < 3) {
            strengthDiv.innerHTML = `<span style="color: #8F0B13;">‚ö†Ô∏è Weak - Add ${feedback.slice(0, 2).join(' and ')}</span>`;
        } else if (score < 4) {
            strengthDiv.innerHTML = `<span style="color: #FFC107;">üü° Medium - Getting stronger!</span>`;
        } else {
            strengthDiv.innerHTML = `<span style="color: #7CEC86;">‚úÖ Strong - Great password!</span>`;
        }
    }
    
    function checkPasswordMatch() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const matchDiv = document.getElementById('password-match');
        
        if (!confirmPassword) {
            matchDiv.innerHTML = '';
            return;
        }
        
        if (newPassword === confirmPassword) {
            matchDiv.innerHTML = `<span style="color: #7CEC86;">‚úÖ Passwords match!</span>`;
        } else {
            matchDiv.innerHTML = `<span style="color: #8F0B13;">‚ùå Passwords don't match</span>`;
        }
    }
    
    async function handlePasswordChangeSubmit(event) {
        event.preventDefault();
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const submitBtn = document.getElementById('change-password-btn');
        
        // Client-side validation
        if (!currentPassword || !newPassword || !confirmPassword) {
            showErrorToast('‚ùå Please fill in all password fields.');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showErrorToast('‚ùå New passwords don\'t match. Please check and try again.');
            return;
        }
        
        if (newPassword.length < 8) {
            showErrorToast('‚ùå New password must be at least 8 characters long.');
            return;
        }
        
        if (currentPassword === newPassword) {
            showErrorToast('‚ö†Ô∏è Your new password must be different from your current password.');
            return;
        }
        
        // Show loading state
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = 'üîÑ Updating...';
        submitBtn.disabled = true;
        
        try {
            // Get Firebase authentication token
            let idToken = null;
            if (window.firebase && window.firebase.auth && window.firebase.auth.currentUser) {
                idToken = await window.firebase.auth.currentUser.getIdToken();
            }
            
            // Make API call to change password
            const response = await fetch('/api/auth/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(idToken ? { 'Authorization': `Bearer ${idToken}` } : {})
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccessToast('üéâ Password updated successfully! Your account is more secure now.');
                closePasswordModal();
                
                // Show additional security message
                setTimeout(() => {
                    showSuccessToast('üí° For security, you may need to log in again on other devices with your new password.');
                }, 2000);
            } else {
                throw new Error(data.error || 'Failed to update password');
            }
            
        } catch (error) {
            console.error('Password change error:', error);
            
            let errorMessage = '‚ùå Something went wrong changing your password. Please try again!';
            
            if (error.message.includes('current password') || error.message.includes('incorrect')) {
                errorMessage = 'üîë Current password is incorrect. Please check and try again.';
            } else if (error.message.includes('network') || error.message.includes('fetch')) {
                errorMessage = 'üåê Network error. Please check your connection and try again.';
            }
            
            showErrorToast(errorMessage);
        } finally {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    // Add helper function for error toasts if it doesn't exist
    if (typeof showErrorToast === 'undefined') {
        window.showErrorToast = function(message) {
            showSuccessToast(message); // Fallback to success toast with error message
        };
    }
    
    window.exportData = function() {
        showSuccessToast('üì§ Data export coming soon! Download all your BrainBudget data in a secure format.');
    };
    
    window.managePreferences = function() {
        showSuccessToast('üéõÔ∏è Advanced preferences coming soon! Fine-tune your personalized experience.');
    };
    
    window.logout = async function() {
        const confirmed = await showConfirmModal({
            icon: 'üö™',
            title: 'Logout from BrainBudget',
            message: 'Are you sure you want to logout? Your progress will be saved and you can come back anytime!',
            cancelText: 'Stay Logged In',
            confirmText: 'Logout'
        });
        
        if (confirmed) {
            // Show logout toast
            showSuccessToast('üëã Logging out... Thanks for using BrainBudget! See you soon!');
            
            // Perform logout after a brief delay
            setTimeout(() => {
                // Make logout API call
                fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Redirect to landing page
                        window.location.href = data.redirect || '/';
                    } else {
                        // Fallback - redirect anyway
                        window.location.href = '/';
                    }
                })
                .catch(error => {
                    console.log('Logout request failed, redirecting anyway');
                    // Fallback - redirect to landing page
                    window.location.href = '/';
                });
            }, 1000);
        }
    };
    
    // User-friendly entrance animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe profile cards for entrance animations
    document.querySelectorAll('.card-hover').forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
    
    // Achievement celebration effect
    const achievements = document.querySelectorAll('[style*="rgba(124, 236, 134, 0.2)"], [style*="rgba(255, 193, 7, 0.2)"], [style*="rgba(139, 92, 246, 0.2)"]');
    achievements.forEach((achievement, index) => {
        achievement.addEventListener('click', () => {
            showSuccessToast('üéâ Achievement unlocked! Your progress journey is inspiring!');
            // Add celebration animation
            achievement.style.animation = 'bounce 0.6s ease-out';
            setTimeout(() => {
                achievement.style.animation = '';
            }, 600);
        });
    });
    
    // Progress bar animation on load
    setTimeout(() => {
        const progressBars = document.querySelectorAll('[style*="width: 92%"]');
        progressBars.forEach((bar, index) => {
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.transition = 'width 2s ease-out';
                bar.style.width = '92%';
            }, index * 300 + 1000);
        });
    }, 500);
});
</script>
{% endblock %}